# Infisical — Self-Hosted Secrets Manager

Machine-facing secrets backend for the homelab. Injects environment variables into Docker Compose stacks at runtime so no secret ever lands in a committed file.

## Architecture

| Container | Purpose | Port |
|---|---|---|
| `infisical` | Core API + UI | `8080` |
| `infisical-db` | PostgreSQL 16 (dedicated) | internal only |
| `infisical-redis` | Redis 7 (sessions/cache) | internal only |

Exposed via NPM at `https://infisical.aser.dk` with a TLS cert from step-ca.

## Quick Start

### 1. Provision the host

Create a Debian 12 LXC on PVE (or reuse an existing Docker host). Install Docker:

```bash
# From the immich repo's scripts:
bash /opt/immich/scripts/install_docker_debian.sh
```

### 2. Clone and deploy

```bash
cd /opt
git clone https://github.com/ElkjarIT/home-portal.git  # or copy the infra/infisical dir
cd home-portal/infra/infisical

# Option A — automated (generates secrets, optionally stores in 1Password)
bash setup.sh          # interactive
bash setup.sh --op     # + 1Password storage

# Option B — manual
cp .env.example .env
# Edit .env — generate ENCRYPTION_KEY and AUTH_SECRET with:
#   openssl rand -hex 16
# Generate DB_PASSWORD with:
#   openssl rand -base64 32 | tr -dc A-Za-z0-9 | head -c 24
docker compose up -d
```

### 3. First-time setup

1. Open `http://<host-ip>:8080`
2. Create the admin account
3. Store credentials in 1Password → vault `Homelab` → item `Infisical – admin`
4. Create project **homelab**, environment **prod**
5. Add all secrets from the security cleanup (HA tokens, DB passwords, etc.)

### 4. Reverse proxy + TLS

```bash
cd ../proxy
bash generate-certs.sh infisical
```

Then in NPM (LXC 102, port 81):
- Add proxy host: `infisical.aser.dk` → `<infisical-host-ip>:8080`
- Upload the cert from `proxy/certs/infisical.aser.dk.{crt,key}`

### 5. Install CLI on service hosts

On each host that runs Docker Compose (immich01, LXC 103, etc.):

```bash
curl -1sLf https://dl.infisical.com/public.key | gpg --dearmor -o /usr/share/keyrings/infisical-archive-keyring.gpg
echo "deb [signed-by=/usr/share/keyrings/infisical-archive-keyring.gpg] https://dl.infisical.com/deb stable main" \
  | tee /etc/apt/sources.list.d/infisical.list
apt update && apt install -y infisical
```

### 6. Use in Docker Compose stacks

Instead of `.env` files with real values, use Infisical injection:

```bash
# Example: start the Immich stack with secrets injected at runtime
infisical run --projectId <id> --env prod -- docker compose up -d
```

## File Layout

```
infisical/
  docker-compose.yml   # Stack definition (committed)
  .env.example         # Template with placeholders (committed)
  .env                 # Real secrets (gitignored, generated by setup.sh)
  setup.sh             # Bootstrap script (committed)
  README.md            # This file
```

## Backup

The PostgreSQL volume (`infisical-db-data`) contains the encrypted secrets vault. Back it up regularly:

```bash
docker exec infisical-db pg_dump -U infisical infisical | gzip > /backup/infisical-$(date +%F).sql.gz
```

The `ENCRYPTION_KEY` in `.env` is required to decrypt the vault. If lost, all secrets are unrecoverable. It is stored in 1Password under `Infisical – encryption key`.
