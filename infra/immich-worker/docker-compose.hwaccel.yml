# ─────────────────────────────────────────────────────────────────────────────
# NVIDIA hardware-acceleration overlay
# ─────────────────────────────────────────────────────────────────────────────
#
# Merge this file with the base compose to enable:
#   - NVENC-accelerated video transcoding on the worker
#   - CUDA-accelerated ML inference (smart search, face detection)
#
#   docker compose -f docker-compose.yml -f docker-compose.hwaccel.yml up -d
#
# Prerequisites:
#   1. NVIDIA Game-Ready or Studio driver installed on the Windows host.
#      (WSL2 GPU support ships with recent NVIDIA drivers — no extra steps.)
#   2. In Immich → Administration → Video Transcoding:
#      set "Hardware Acceleration" to NVENC.
# ─────────────────────────────────────────────────────────────────────────────

name: immich-worker

services:
  immich-worker:
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu, video]
    environment:
      NVIDIA_DRIVER_CAPABILITIES: all
      NVIDIA_VISIBLE_DEVICES: all

  immich-machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:${IMMICH_VERSION:-release}-cuda
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu, compute]
    environment:
      NVIDIA_DRIVER_CAPABILITIES: all
      NVIDIA_VISIBLE_DEVICES: all
