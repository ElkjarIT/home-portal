# ─────────────────────────────────────────────────────────────────────────────
# NVIDIA NVENC hardware-acceleration overlay
# ─────────────────────────────────────────────────────────────────────────────
#
# Merge this file with the base compose to enable GPU-accelerated video
# transcoding via NVENC on Chappie:
#
#   docker compose -f docker-compose.yml -f docker-compose.hwaccel.yml up -d
#
# Prerequisites:
#   1. NVIDIA Game-Ready or Studio driver installed on the Windows host.
#      (WSL2 GPU support ships with recent NVIDIA drivers — no extra steps.)
#   2. In Immich → Administration → Video Transcoding:
#      set "Hardware Acceleration" to NVENC.
# ─────────────────────────────────────────────────────────────────────────────

name: immich-worker

services:
  immich-worker:
    # RTX 3080 12 GB — supports several concurrent NVENC sessions.
    # Actual transcode concurrency is set in Immich Admin → Jobs.
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu, video]
    environment:
      NVIDIA_DRIVER_CAPABILITIES: all
      NVIDIA_VISIBLE_DEVICES: all
      # Pre-allocate CUDA context once to avoid repeated init overhead
      CUDA_DEVICE_ORDER: PCI_BUS_ID

  immich-machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:${IMMICH_VERSION:-release}-cuda
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu, compute]
    environment:
      MACHINE_LEARNING_WORKERS: 3
      MACHINE_LEARNING_REQUEST_THREADS: 4
      NVIDIA_DRIVER_CAPABILITIES: all
      NVIDIA_VISIBLE_DEVICES: all
