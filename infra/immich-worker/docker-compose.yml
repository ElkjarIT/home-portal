# ─────────────────────────────────────────────────────────────────────────────
# Immich worker-only node — Chappie (Windows 11 / Docker Desktop / WSL2)
# ─────────────────────────────────────────────────────────────────────────────
#
# Runs Immich background microservices workers (video transcode, thumbnails,
# smart-search, etc.) with the API/web layer explicitly disabled.
# Shares Postgres, Redis and the library mount with the primary Immich server
# on the Proxmox VM — no state lives here, so this node can be started or
# stopped at any time without affecting the primary server.
#
# Usage (CPU transcoding):
#   cp .env.example .env    # fill in DB_*, REDIS_*, UPLOAD_LOCATION
#   docker compose up -d
#
# Usage (NVIDIA NVENC hardware acceleration):
#   docker compose -f docker-compose.yml -f docker-compose.hwaccel.yml up -d
#
# Graceful shutdown:
#   docker compose down     # running jobs re-queue; primary server continues
# ─────────────────────────────────────────────────────────────────────────────

name: immich-worker

services:
  immich-worker:
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-release}
    container_name: immich_worker
    restart: unless-stopped

    # No ports published — this node has no web UI or API surface.

    environment:
      # Disable the API server; run only background microservices workers.
      IMMICH_WORKERS_EXCLUDE: "api"

      # ── Database (primary server) ─────────────────────────────────────────
      DB_HOSTNAME: ${DB_HOSTNAME}
      DB_PORT: ${DB_PORT:-5432}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_DATABASE_NAME: ${DB_DATABASE_NAME}

      # ── Redis (primary server) ────────────────────────────────────────────
      REDIS_HOSTNAME: ${REDIS_HOSTNAME}
      REDIS_PORT: ${REDIS_PORT:-6379}

      TZ: ${TZ:-Europe/Copenhagen}

    volumes:
      # Must be the SAME upload/library content that the primary server mounts.
      # Mount the SMB/NFS share on this host before starting the container.
      - ${UPLOAD_LOCATION}:/usr/src/app/upload

    # No healthcheck: the worker process has no HTTP endpoint when the API is
    # excluded. Monitor via `docker logs -f immich_worker` or Immich job queue.
