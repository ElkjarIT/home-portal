# ─────────────────────────────────────────────────────────────────────────────
# Immich worker-only node — Chappie (Windows 11 / Docker Desktop / WSL2)
# ─────────────────────────────────────────────────────────────────────────────
#
# Runs Immich background microservices workers (video transcode, thumbnails,
# smart-search, etc.) with the API/web layer explicitly disabled.
# Shares Postgres, Redis and the library mount with the primary Immich server
# on the Proxmox VM — no state lives here, so this node can be started or
# stopped at any time without affecting the primary server.
#
# Prerequisites:
#   Create the Docker CIFS volume once before first start (see .env.example):
#   docker volume create --driver local --opt type=cifs \
#     --opt device=//10.10.40.40/immich-data \
#     "--opt" "o=addr=10.10.40.40,username=odin,password=<SMB_PASS>,uid=1000,gid=1000,file_mode=0660,dir_mode=0770" \
#     immich-data
#
# Usage (CPU transcoding):
#   cp .env.example .env    # fill in DB_* and REDIS_*
#   docker compose up -d
#
# Usage (NVIDIA NVENC hardware acceleration):
#   docker compose -f docker-compose.yml -f docker-compose.hwaccel.yml up -d
#
# Graceful shutdown:
#   docker compose down     # running jobs re-queue; primary server continues
# ─────────────────────────────────────────────────────────────────────────────

name: immich-worker

services:
  immich-worker:
    image: ghcr.io/immich-app/immich-server:${IMMICH_VERSION:-release}
    container_name: immich_worker
    restart: unless-stopped

    # No ports published — this node has no web UI or API surface.

    environment:
      # Disable the API server; run only background microservices workers.
      IMMICH_WORKERS_EXCLUDE: "api"

      # ── Upload/library paths — MUST match the primary server's configuration ──
      # The primary server uses /opt/immich/uploads inside the container.
      UPLOAD_LOCATION: /opt/immich/uploads
      IMMICH_MEDIA_LOCATION: /opt/immich/uploads

      # ── Database (primary server) ─────────────────────────────────────────
      DB_HOSTNAME: ${DB_HOSTNAME}
      DB_PORT: ${DB_PORT:-5432}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      DB_DATABASE_NAME: ${DB_DATABASE_NAME}

      # ── Redis (primary server) ────────────────────────────────────────────
      REDIS_HOSTNAME: ${REDIS_HOSTNAME}
      REDIS_PORT: ${REDIS_PORT:-6379}

      TZ: ${TZ:-Europe/Copenhagen}

    volumes:
      # Docker-native CIFS volume mounting the full /data/immich root at /opt/immich.
      # This gives the worker access to uploads, icloud, messages and all other paths
      # that assets may reference — matching the primary server's full volume layout.
      # Create with `docker volume create immich-data ...` before first start (see header).
      - immich-data:/opt/immich

    # No healthcheck: the worker process has no HTTP endpoint when the API is
    # excluded. Monitor via `docker logs -f immich_worker` or Immich job queue.

volumes:
  immich-data:
    external: true   # Created separately via docker volume create (see header)
